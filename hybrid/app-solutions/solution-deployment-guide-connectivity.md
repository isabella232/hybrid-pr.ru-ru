---
title: Настройка подключения к гибридному облаку с помощью Azure и Azure Stack Hub
description: Узнайте, как настроить подключение к гибридному облаку с помощью Azure и Azure Stack Hub.
author: BryanLa
ms.topic: article
ms.date: 11/05/2019
ms.author: bryanla
ms.reviewer: anajod
ms.lastreviewed: 11/05/2019
ms.openlocfilehash: 4480f51b03082f2a0cbb7f2f213e05b7bf488646
ms.sourcegitcommit: 962334135b63ac99c715e7bc8fb9282648ba63c9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104895385"
---
# <a name="configure-hybrid-cloud-connectivity-using-azure-and-azure-stack-hub"></a>Настройка подключения к гибридному облаку с помощью Azure и Azure Stack Hub

Доступ к ресурсам безопасности в глобальных Azure и Azure Stack Hub можно получить, используя модель гибридного подключения.

В этом решении показано, как создать среду, после чего вы выполните в ней следующие действия:

> [!div class="checklist"]
> - Сохранять данные локально в соответствии с требованиями конфиденциальности или нормативными требованиями, обеспечивая доступ к глобальным ресурсам Azure.
> - Сохранять устаревшую систему при использовании ресурсов и развертывании приложения в масштабе облака, а также хранить ресурсы в глобальной среде Azure.

> [!Tip]  
> ![Схема основных аспектов проектирования гибридных приложений](./media/solution-deployment-guide-cross-cloud-scaling/hybrid-pillars.png)  
> Microsoft Azure Stack Hub — это расширение Azure. Azure Stack Hub обеспечивает гибкость и высокую скорость внедрения инноваций облачных вычислений в локальной среде. Это решение позволяет использовать единственное гибридное облако, с помощью которого можно создавать и развертывать гибридные приложения в любой точке мира.  
> 
> В руководстве по [проектированию гибридных приложений](overview-app-design-considerations.md) перечислены основные аспекты качественного программного обеспечения (размещение, масштабируемость, доступность, устойчивость, управляемость и безопасность), которые следует учитывать при разработке, развертывании и использовании гибридных приложений. Эти рекомендации помогут оптимизировать разработку гибридных приложений и предотвратить появление проблем с рабочими средами.

## <a name="prerequisites"></a>Предварительные требования

Для развертывания гибридного подключения требуется несколько компонентов. Подготовка некоторых из них требует определенного времени, и это необходимо учитывать при планировании.

### <a name="azure"></a>Azure

- Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.
- Создайте [веб-приложение](/aspnet/core/tutorials/publish-to-azure-webapp-using-vs) в Azure. Запишите URL-адрес веб-приложения для дальнейшего использования в решении.

### <a name="azure-stack-hub"></a>Azure Stack Hub

Партнер-поставщик OEM или оборудования может развернуть рабочую среду Azure Stack Hub, а все пользователи могут развернуть Пакет средств разработки Azure Stack (ASDK).

- Используйте рабочий Azure Stack Hub или разверните ASDK.
   >[!Note]
   >Развертывание ASDK может занять 7 часов. Учитывайте это при планировании.

- Разверните службы PaaS [Службы приложений](/azure-stack/operator/azure-stack-app-service-deploy) в Azure Stack Hub.
- [Создайте планы и предложения](/azure-stack/operator/service-plan-offer-subscription-overview) в среде Azure Stack Hub.
- [Создайте подписку клиента](/azure-stack/operator/azure-stack-subscribe-plan-provision-vm) в рамках среды Azure Stack Hub.

### <a name="azure-stack-hub-components"></a>Компоненты Azure Stack Hub

Оператор Azure Stack Hub должен развернуть службу приложений, создать планы и предложения, создать подписку клиента и добавить образ Windows Server 2016. Если у вас уже есть эти компоненты, перед началом работы с решением убедитесь, что они отвечают требованиям.

В этом примере решения также предполагается, что вы обладаете основными знаниями об Azure и Azure Stack Hub. Перед началом работы с решением прочитайте следующие статьи:

- [Введение в Azure](https://azure.microsoft.com/overview/what-is-azure/).
- [Обзор Azure Stack Hub](/azure-stack/operator/azure-stack-overview)

### <a name="before-you-begin"></a>Перед началом

Перед началом настройки гибридного облачного подключения убедитесь, что выполняются следующие условия:

- У вас есть внешний общедоступный IPV4-адрес для VPN-устройства. Этот IP-адрес не может быть за устройством NAT.
- Все ресурсы должны быть развернуты в одном регионе и (или) расположении.

#### <a name="solution-example-values"></a>Примеры значений для решения

В примерах для этого решения используйте следующие значения. Вы можете создать на их основе тестовую среду или просто изучить для лучшего понимания примеров. Дополнительные сведения о параметрах шлюза VPN см. в разделе [Сведения о параметрах VPN-шлюза](/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings).

Спецификации подключения:

- **Тип VPN**: на основе маршрутов.
- **Тип подключения**: "сеть — сеть" (IPsec).
- **Тип шлюза.** Виртуальная частная сеть
- **Имя подключения Azure**. Azure-Gateway-AzureStack-S2SGateway (портал заполнит это значение автоматически).
- **Имя подключения Azure Stack Hub**: AzureStack-Gateway-Azure-S2SGateway (портал заполнит это значение автоматически).
- **Общий ключ**: все совместимые с оборудованием VPN с соответствующими значениями на обеих сторонах подключения.
- **Подписка**: любая подписка.
- **Группа ресурсов.** Тест Infra.

IP-адреса сетей и подсетей:

| Подключение Azure или Azure Stack Hub | Имя | Подсеть | IP-адрес |
|---|---|---|---|
| Виртуальная сеть Azure | ApplicationvNet<br>10.100.102.9/23 | ApplicationSubnet<br>10.100.102.0/24 |  |
|  |  | Подсеть шлюза<br>10.100.103.0/24 |  |
| Виртуальная сеть Azure Stack Hub | ApplicationvNet<br>10.100.100.0/23 | ApplicationSubnet <br>10.100.100.0/24 |  |
|  |  | Подсеть шлюза <br>10.100101.0/24 |  |
| Шлюз виртуальной сети Azure | Azure-Gateway |  |  |
| Шлюз виртуальной сети Azure Stack Hub | AzureStack-Gateway |  |  |
| Общедоступный IP-адрес Azure | Azure-GatewayPublicIP |  | Определяется в момент создания |
| Общедоступный IP-адрес Azure Stack Hub | AzureStack-GatewayPublicIP |  | Определяется в момент создания |
| Шлюз локальной сети Azure | AzureStack-S2SGateway<br>   10.100.100.0/23 |  | Значение общедоступного IP-адреса Azure Stack Hub |
| Шлюз локальной сети Azure Stack Hub | Azure-S2SGateway<br>10.100.102.0/23 |  | Значение общедоступного IP-адреса Azure |

## <a name="create-a-virtual-network-in-global-azure-and-azure-stack-hub"></a>Создание виртуальной сети в глобальных Azure и Azure Stack Hub

Чтобы создать виртуальную сеть с помощью портала, сделайте следующее. Если вы используете статью только для предложенного решения, то можете использовать эти [примеры значений](/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal#values). Если вы настраиваете реальную рабочую среду, замените эти примеры соответствующими значениями.

> [!IMPORTANT]
> Следите за тем, чтобы IP-адреса в адресных пространствах виртуальной сети Azure и (или) Azure Stack Hub не перекрывались.

Чтобы создать виртуальную сеть в Azure, сделайте следующее:

1. В браузере откройте [портал Azure](https://portal.azure.com/) и выполните вход с учетной записью Azure.
2. Выберите **Создать ресурс**. В поле **Поиск по marketplace** введите "виртуальная сеть". Выберите **Виртуальная сеть** в результатах.
3. В списке **Выбор модели развертывания** выберите **Resource Manager** и щелкните **Создать**.
4. На странице **Создание виртуальной сети** настройте параметры виртуальной сети. Красной звездочкой здесь отмечены обязательные для заполнения поля.  Когда вы введете в такое поле допустимое значение, звездочка сменится зеленым флажком.

Чтобы создать виртуальную сеть в Azure Stack Hub, сделайте следующее:

1. Повторите приведенные выше действия (1–4) с помощью **портала клиента** Azure Stack Hub.

## <a name="add-a-gateway-subnet"></a>Добавление подсети шлюза

Прежде чем подключать шлюз к виртуальной сети, следует создать подсеть шлюза для виртуальной сети, к которой вы хотите его подключить. Службы шлюза используют IP-адреса, указанные для подсети шлюза.

На [портале Azure](https://portal.azure.com/) перейдите к виртуальной сети Resource Manager, в которой вы хотите создать шлюз виртуальной сети.

1. Выберите виртуальную сеть, чтобы открыть страницу **Виртуальная сеть**.
2. В разделе **Параметры** выберите **Подсети**.
3. На странице **Подсети** щелкните **+Gateway subnet** (+Подсеть шлюза). Откроется страница **Добавление подсети**.

    ![Добавление подсети шлюза](media/solution-deployment-guide-connectivity/image4.png)

4. Поле **Имя** для подсети автоматически заполнится значением GatewaySubnet. По этому имени Azure идентифицирует подсеть как подсеть шлюза.
5. Измените значения **Диапазон адресов** так, чтобы они соответствовали требованиям к конфигурации, а затем нажмите кнопку **ОК**.

## <a name="create-a-virtual-network-gateway-in-azure-and-azure-stack"></a>Создание шлюза виртуальной сети в Azure и Azure Stack

Чтобы создать виртуальную сеть в Azure, сделайте следующее:

1. На странице портала слева щелкните **+** и введите "шлюз виртуальной сети" в поле поиска.
2. В списке **результатов** выберите **Шлюз виртуальной сети**.
3. На странице **Шлюз виртуальной сети** щелкните **Создать**, чтобы открыть страницу **Создание шлюза виртуальной сети**.
4. На странице **Создание шлюза виртуальной сети** укажите значения для сетевого шлюза, используя **примеры значений из учебника**. В том числе следующие дополнительные значения:

   - **Номер SKU**. Базовый.
   - **Виртуальная сеть**. Выберите созданную ранее виртуальную сеть. Автоматически выберется созданная ранее подсеть шлюза.
   - **Первая IP-конфигурация**.  Это общедоступный IP-адрес вашего шлюза.
     - Щелкните **Создать IP-конфигурацию шлюза**, чтобы перейти на страницу **Выбор общедоступного IP-адреса**.
     - Выберите **+Создать**, чтобы открыть страницу **Создание общедоступного IP-адреса**.
     - Укажите **имя** для общедоступного IP-адреса. Сохраните для номера SKU значение **Базовый**, а затем нажмите кнопку **ОК**, чтобы сохранить изменения.

       > [!Note]
       > Сейчас VPN-шлюз поддерживает только динамическое выделение общедоступных IP-адресов. Но это не означает, что IP-адрес изменится после того, как он будет назначен VPN-шлюзу. Общедоступный IP-адрес изменяется только после удаления и повторного создания шлюза. IP-адрес VPN-шлюза не изменяется при изменении размера, сбросе или других внутренних операциях обслуживания или обновления.

5. Проверьте параметры шлюза.
6. Выберите **Создать** для создания VPN-шлюза. Будут проверены параметры шлюза и на панели мониторинга появится плитка "Развертывание шлюза виртуальной сети".

   >[!Note]
   >Создание шлюза может занять до 45 минут. Вам понадобится обновить страницу портала, чтобы увидеть готовое состояние.

    После создания шлюза можно узнать назначенный ему IP-адрес, просмотрев виртуальную сеть на портале. Шлюз будет отображаться как подключенное устройство. Чтобы просмотреть дополнительные сведения о шлюзе, выберите устройство.

7. Повторите описанные выше шаги (1–5) для развертывания Azure Stack Hub.

## <a name="create-the-local-network-gateway-in-azure-and-azure-stack-hub"></a>Создание шлюза локальной сети в Azure и Azure Stack Hub

Обычно термин "шлюз локальной сети" означает локальное расположение. Присвойте сайту имя, которое могут использовать Azure и (или) Azure Stack Hub, а затем укажите следующие данные:

- IP-адрес локального VPN-устройства, для которого вы создаете подключение.
- Префиксы IP-адресов, которые будут направляться через VPN-шлюз к VPN-устройству. Указываемые префиксы адресов расположены в локальной сети.

  >[!Note]
  >Если изменятся параметры локальной сети или потребуется изменить общедоступный IP-адрес для VPN-устройства, эти значения можно обновить позже.

1. На портале выберите **+ Создать ресурс**.
2. В поле поиска введите **шлюз локальной сети** и нажмите клавишу **ВВОД**. Будет возвращен список результатов.
3. Выберите **Шлюз локальной сети**, а затем щелкните **Создать**, чтобы открыть страницу **Создание шлюза локальной сети**.
4. На странице **Создание шлюза локальной сети** укажите значения для локального сетевого шлюза, представленные в **примере значений для руководства**. В том числе следующие дополнительные значения:

    - **IP-адрес**. Это общедоступный IP-адрес VPN-устройства, к которому вы хотите подключить Azure или Azure Stack Hub. Укажите допустимый общедоступный IP-адрес, не расположенный за устройством NAT, чтобы обеспечить к нему доступ для Azure. Если у вас нет IP-адреса прямо сейчас, можно использовать значение из примера в качестве заполнителя. Необходимо вернуться и заменить заполнитель общедоступным IP-адресом VPN-устройства. Azure не сможет подключиться к устройству, пока вы не предоставите правильный адрес.
    - **Адресное пространство**: это диапазон адресов для сети, которую представляет эта локальная сеть. Можно добавить несколько диапазонов пространства адресов. Убедитесь, что указанные диапазоны не перекрывают диапазоны других сетей, к которым вы хотите подключиться. Azure будет маршрутизировать указанный диапазон адресов на IP-адрес локального VPN-устройства. Чтобы подключиться к локальному сайту, используйте здесь значения для локального сайта, а не значения из примера.
    - **Настроить параметры BGP**. Используйте только при настройке BGP. В противном случае не выбирайте этот параметр.
    - **Подписка**: Убедитесь, что указана правильная подписка.
    - **Группа ресурсов**. Выберите группу ресурсов, которую нужно использовать. Вы можете создать новую группу ресурсов или выбрать уже существующую.
    - **Расположение.** Укажите расположение, в котором будет создан этот объект. Вы можете выбрать расположение, в котором размещена виртуальная сеть, но это не обязательно.
5. Завершив ввод необходимых значений, выберите **Создать** для создания шлюза локальной сети.
6. Повторите эти шаги (1–5) для развертывания Azure Stack Hub.

## <a name="configure-your-connection"></a>Настройка подключения

Для подключения "сеть — сеть" к локальной сети требуется VPN-устройство. Настроенное VPN-устройство здесь обозначается как "Подключение". Для настройки подключения вам потребуется следующее:

- Общий ключ. Это тот же общий ключ, который указывается при создании VPN-подключения "сеть — сеть". В наших примерах мы используем простые общие ключи. Для практического использования рекомендуется создавать более сложные ключи.
- Общедоступный IP-адрес шлюза виртуальной сети. Общедоступный IP-адрес можно просмотреть с помощью портала Azure, PowerShell или CLI. Чтобы найти общедоступный IP-адрес VPN-шлюза с помощью портала Azure, перейдите к разделу "Шлюзы виртуальной сети" и выберите имя шлюза.

Чтобы создать VPN-подключение "сеть — сеть" между шлюзом виртуальной сети и локальным VPN-устройством, сделайте следующее:

1. На портале Azure выберите **+Создать ресурс**.
2. Выполните поиск по строке **подключения**.
3. В **списке результатов** выберите **Подключения**.
4. На странице **Подключение** выберите **Создать**.
5. На странице **Создание подключения** настройте следующие параметры:

    - **Тип подключения**. Выберите подключение "сеть — сеть" (IPsec).
    - **Группа ресурсов**. Выберите тестовую группу ресурсов.
    - **Шлюз виртуальной сети**. Выберите созданный шлюз виртуальной сети.
    - **Локальный сетевой шлюз**. Выберите созданный шлюз локальной сети.
    - **Имя подключения**. Это имя заполняется автоматически с использованием значений из двух шлюзов.
    - **Общий ключ**. Это значение должно соответствовать значению, используемому для локального VPN-устройства. В этом руководстве используется значение abc123, но вам нужно создать и использовать что-нибудь посложнее. Здесь *важно*, чтобы заданное значение совпадало со значением, указанным при настройке VPN-устройства.
    - Значения для **подписки**, **группы ресурсов** и **расположения** являются фиксированными.

6. Щелкните **ОК** для создания подключения.

Данные созданного подключения появятся на странице **Подключения** для шлюза виртуальной сети. Состояние изменится с *Unknown* (Неизвестно) на *Подключение*, а затем — *Успешно*.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о шаблонах для облака Azure см. в статье [Конструктивные шаблоны облачных решений](/azure/architecture/patterns).
